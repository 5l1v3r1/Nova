<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Nova</title>
    <link rel="stylesheet" type="text/css" href="style.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/dojo/dijit/themes/claro/claro.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/dojo/dojox/grid/resources/Grid.css"/>
    <link rel="stylesheet" type="text/css" href="/dojo/dojox/grid/resources/claroGrid.css"/>

    <script src="/dojo/dojo/dojo.js" 
            data-dojo-config="async:true, parseOnLoad:true"></script>
    <script type="text/javascript" src="/nowjs/now.js"></script>

    <script>
    
    function updateNovadStatus(isNovadUp){
        dojo.byId("nova_status").innerHTML = isNovadUp ? "Up" : "Down";
     };
 
    function updateHaystackStatus(isHaystackUp){
        dojo.byId("haystack_status").innerHTML = isHaystackUp ? "Up" : "Down";
    };
 

      require(["dijit/layout/BorderContainer", "dijit/layout/TabContainer", "dijit/layout/ContentPane", "dijit/form/Button", "dojo/parser"]);
      

      require(["dojo/ready","dojo/store/Memory", "dojo/store/Observable", "dojo/data/ObjectStore"], function(ready){ready(function(){
        dojo.addOnLoad(function(){

          // Update the status every 5 seconds
          setInterval("now.IsNovadUp(updateNovadStatus)", 5000);
          setInterval("now.IsHaystackUp(updateHaystackStatus)", 5000);


          suspectStore = new dojo.store.Observable(new dojo.store.Memory());
          suspectStore.idProperty="GetInAddr";
          var suspectGrid;

          // Formatter for the classification
          function classificationFormatter(d)
          {
                var num = new Number(d);
                return (num.toFixed(6));
          }
         
          // Formatter for the floating point features
          function featureFormatter(d)
          {
                var num = new Number(d);
                return (num.toFixed(2));
          }


          require(["dojox/grid/DataGrid","dojo/data/ObjectStore","dojo/domReady!"],
                  function(DataGrid,ObjectStore){

                     suspectGrid = new DataGrid(
                        {
                          store: dataStore = dojo.data.ObjectStore({objectStore: suspectStore}),
                          structure: [ {name:"Address", field:"GetInAddr", width:"150px"}, 
                                       {name:"Classification", field:"GetClassification", width:"150px", formatter: classificationFormatter},
                                       {name:"Hostile", field:"GetIsHostile"},
                                       {name:"IP traffic distribution", field:"ip_traffic_distribution", formatter: featureFormatter},
                                       {name:"Port traffic distribution", field:"port_traffic_distribution", formatter: featureFormatter},
                                       {name:"Haystack event frequency", field:"haystack_event_frequency", formatter: featureFormatter},
                                       {name:"Packet Size Mean", field:"packet_size_mean", formatter: featureFormatter},
                                       {name:"Packet Size Deviation", field:"packet_size_deviation", formatter: featureFormatter},
                                       {name:"IPs Contacted", field:"distinct_ips"},
                                       {name:"Ports Contacted", field:"distinct_ports"},
                                       {name:"Packet Interval Mean", field:"packet_interval_mean", formatter: featureFormatter},
                                       {name:"Packet Interval Deviation", field:"packet_interval_deviation", formatter: featureFormatter},
                                     ],
                        }, 
                        "nova_suspects"
                     );

                     suspectGrid.startup();
          });


          now.OnNewSuspect(function(suspect){
            // This is probably a really bad way to do this...
             for (var i in suspect.GetFeatures) {  
                 suspect[i] = suspect.GetFeatures[i];
                }
             
             if( suspectStore.get(suspect.GetInAddr) )
             {       
               suspectStore.put(suspect,{id: suspect.GetInAddr, overwrite: true});
               suspectGrid.render();
             }
             else
             {
               suspectStore.add(suspect,{id: suspect.GetInAddr}); 
             }

          });
      
        });
              
        }); });
      
    </script>
    </head>

  <body class="claro">
    
    <!-- Top-level layout -->
    <div id="appLayout" class="demoLayout" data-dojo-type="dijit.layout.BorderContainer" data-dojo-props="design: 'headline'">
      
      <!-- Tab control -->
      <div class="centerPanel" data-dojo-type="dijit.layout.TabContainer" data-dojo-props="region: 'center', tabPosition: 'bottom'">

        <!-- First tab -->
        <div data-dojo-type="dijit.layout.ContentPane" title="Suspects">
          <h4>Suspect List</h4>
          <div id="nova_suspects">
          </div>
        </div>

        <!-- Second tab -->
        <div data-dojo-type="dijit.layout.ContentPane" title="Tab 2">
          <h4>Tab 2</h4>
        </div>

      <!-- End of tab control -->
      </div>
      
      <!-- Header panel -->
      <div class="edgePanel" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region: 'top', splitter: 'true'">
        <div data-dojo-type="dijit.layout.BorderContainer" data-dojo-props="design: 'sidebar'" style="height: 125px;">

          <!-- Header center -->
          <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region: 'center'">    
            <H1>NOVA: Network Obfuscation and Virtualized Anti-reconnaissance System</H1>
          </div>

          <!-- Header bottom -->
          <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region: 'bottom',layoutPriority:1">
            <div style="float: left">Novad Status: </div><div id="nova_status">unknown</div>
            <div style="float: left">Haystack Status: </div><div id="haystack_status">unknown</div>
          </div>

        </div>
      <!-- End of header panel -->
      </div>
      
      <!-- Left panel -->
      <div id="leftCol" class="edgePanel" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region: 'left', splitter: true">

        <button data-dojo-type="dijit.form.Button" type="button">Start Nova
          <script type="dojo/method" data-dojo-event="onClick">
            now.StartNovad();
          </script>
        </button>
        
        <button data-dojo-type="dijit.form.Button" type="button">Stop Nova
          <script type="dojo/method" data-dojo-event="onClick">
            now.StopNovad();
          </script>
        </button>
            
        <button data-dojo-type="dijit.form.Button" type="button">Start Haystack
          <script type="dojo/method" data-dojo-event="onClick">
            now.StartHaystack();
          </script>
        </button>
        
        <button data-dojo-type="dijit.form.Button" type="button">Stop Haystack
          <script type="dojo/method" data-dojo-event="onClick">
            now.StopHaystack();
          </script>
        </button>
            

        <button data-dojo-type="dijit.form.Button" type="button">Clear All Suspects
          <script type="dojo/method" data-dojo-event="onClick">
            now.ClearAllSuspects();
          </script>
        </button>
      <!-- End of left panel -->
      </div>

    <!-- End of top-level layout -->
    </div>

  </body>
</html>
