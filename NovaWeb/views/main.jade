extends layout

block topPannelAdditions
  div(style="float: left") Novad Status:&nbsp 
  div#nova_status unknown
  div(style="float: left") Haystack Status:&nbsp  
  div#haystack_status unknown
 

block content
  h1 Nova Control Panel
  button(type="button", style="width:160px", onClick='now.StartNovad()') Start Nova
  button(type="button", style="width:160px", onClick='now.StopNovad()') Stop Nova
  
  br
  br
  
  button(type="button", style="width:160px", onClick='now.StartHaystack()') Start Haystack
  button(type="button", style="width:160px", onClick='now.StopHaystack()') Stop Haystack
  
  br
  br
  
  button(type="button", style="width:160px", onClick='now.ClearAllSuspects(); clearDataGrid();') Clear All Suspects

  br

  div#nova_suspects_header
    h1 Suspect List
    button#liveUpdateButton(data-dojo-type="dijit.form.Button",type="button") Pause Updates/Auto Scrolling
      script(type="dojo/method", data-dojo-event="onClick", data-dojo-args="evt")
        | liveUpdate = !liveUpdate;
        | if (!liveUpdate) {dojo.byId("liveUpdateButton").innerHTML = "Unpause updates/Auto Scrolling";}
        | else {dojo.byId("liveUpdateButton").innerHTML = "Pause updates/Auto Scrolling";}
    br
    br
    
    
    a(href="javascript:void(0)", onClick="document.getElementById('advancedFiltering').style.display='block';")
      p Advanced Filtering Options
    div#advancedFiltering(style="display: none;")
      br
      p Filter by IP (supports standard regular expressions. Example: "192.168.10.*|192.168.3.*")
      input#ipFilter(type="text", name="ipFilter", value="")
      br
      p Use 'x' in expressions to denote the specified feature value. Example: "x > 0 && x != 17"
      -var count = 0;
      each feature in featureNames
        if enabledFeatures.charAt(count) == '1'
          label #{feature}
          br
          input(type="text", id="advancedFilter#{count}")
          br
        - count++;
      br
      button(onClick='applyAdvancedFilter()') Apply Advanced Filters
      button(onClick='disableAdvancedFilter()') Disable Advanced Filters

  div#nova_suspects
  div(data-dojo-type="dijit.layout.ContentPane", title="Suspects", id="nova_suspects_error_view", style="display: none")
   h4 Novad is not currently connected or running. Try starting it.
   
block headerAdditions
  script 
    var suspectStore;
    var suspectGrid;
    var liveUpdate = true;

    var advancedFilters = new Object();
    var advancedFilterEnabled = false;
    var advancedIpFilter = null;

    require(["dijit/form/TextBox"]);

    now.updateNovadStatus = function (isNovadUp){
      dojo.byId("nova_status").innerHTML = isNovadUp ? "Up" : "Down";
      dojo.byId("nova_suspects_header").style.display = isNovadUp ? "block" : "none";
      dojo.byId("nova_suspects").style.display = isNovadUp ? "block" : "none";
      dojo.byId("nova_suspects_error_view").style.display = isNovadUp ? "none" : "block";
    };

    now.updateHaystackStatus = function (isHaystackUp){
      dojo.byId("haystack_status").innerHTML = isHaystackUp ? "Up" : "Down";
    };

    now.AllSuspectsCleared = function() {
      clearDataGrid();
    }
      
    function pad(num) {
        return ("0" + num.toString()).slice(-2);
    }

    now.OnNewSuspect = function(suspect){
       var type = "#{type}";
      
       if (type == "hostile" && !suspect.GetIsHostile) {return;}
       if (type == "unclassified" && (suspect.GetClassification > 0)) {return;}
       if (type == "all" && suspect.GetClassification < 0) {return;}

       if(!liveUpdate) {return;}
      
      var d = new Date(suspect.GetLastPacketTime*1000);
      var dString = pad(d.getMonth()) + "/" + pad(d.getDate()) + " " + pad(d.getHours()) + ":" + pad(d.getMinutes()) + ":" + pad(d.getSeconds());
      suspect.LastPacketString = dString;
      
      // This is probably a really bad way to do this...
      for (var i in suspect.GetFeatures) {  
        suspect[i] = suspect.GetFeatures[i];
      }
       
       if (advancedFilterEnabled) {
         for (var i in advancedFilters) {
             var x = String(suspect[i]);
             var expr = String(advancedFilters[i]);
             if (!eval(expr)) {
                return;
             }
         }

         if (advancedIpFilter != null) {
            if (!advancedIpFilter.test(suspect.GetInAddr)) {
                return;
            }
         }
       }

     
     if( suspectStore.get(suspect.GetInAddr) ) {       
        suspectStore.put(suspect,{id: suspect.GetInAddr, overwrite: true});
      } else {
        suspectStore.add(suspect,{id: suspect.GetInAddr}); 
      }
    };
       
    var clearDataGrid = function() {
      suspectStore = new dojo.store.Memory();
      suspectStore = dojo.store.Observable(suspectStore);
      suspectStore.idProperty="GetInAddr";
      suspectGrid.setStore(dojo.data.ObjectStore({objectStore: suspectStore, clearOnClose: true}));
    }


    var applyAdvancedFilter = function() {
        var patt = new RegExp("^[1234567890x\. ()<>=!&|]+$");
        var featureNames = String("#{featureNames}").split(",");
        for (var i = 0; i < featureNames.length; i++) {
            var filter = "";
            var id = "advancedFilter" + String(i);
            var element = document.getElementById(id);
            if (element != null) {
                filter = element.value;
            }

            if (filter == "") {
                continue;
            }

            if (!patt.test(filter)) {
                alert("Invalid filter: " + filter);
                return;
            } else {
                // Can we evaluate the expression?
                try {
                    var x = 2.5;
                    eval(filter);
                    advancedFilters[i] = filter;
                } catch (err) {
                    alert("Invalid filter: " + filter);
                    return;
                }
            }
        }

        var filter = document.getElementById("ipFilter").value;
        if (filter != "") {
            try {
                advancedIpFilter = new RegExp(filter);
            } catch (err) {
                alert("Invalid filter: " + filter);
                return;
            }
        }

        advancedFilterEnabled = true;
        clearDataGrid();
        now.sendAllSuspects(now.OnNewSuspect);
    };

    var disableAdvancedFilter = function() {
        document.getElementById('advancedFiltering').style.display='none';
        
        advancedFilterEnabled = false;
        var advancedFilters = new Object();
        
        clearDataGrid();
        now.sendAllSuspects(now.OnNewSuspect);
    }

    require(["dojo/ready","dojo/store/Memory", "dojo/store/Observable", "dojo/data/ObjectStore"], function(ready){ready(function(){ 
    dojo.addOnLoad(function(){
      suspectStore = new dojo.store.Memory();
      suspectStore = dojo.store.Observable(suspectStore);
      suspectStore.idProperty="GetInAddr";
      // Formatter for the classification
      function classificationFormatter(d) {
        
        var bar = new dijit.ProgressBar({progress:d, maximum:1}, "bar");
        bar._destroyOnRemove = true;
        return bar;
      }

      // Formatter for the floating point features
      function featureFormatter(d) {
        var num = new Number(d);
        return (num.toFixed(2));
      }
    
    require(["dojox/grid/DataGrid","dojo/data/ObjectStore","dojo/domReady!"],
    function(DataGrid,ObjectStore){

    var enabledFeatures = String(#{enabledFeatures});
    var gridStructure = new Array();
    gridStructure.push({name:"Address", field:"GetInAddr", width:"125px"});
    gridStructure.push({name:"Classification", field:"GetClassification", width:"150px", formatter: classificationFormatter});
    gridStructure.push({name:"Last Seen", field:"LastPacketString", width: "100px"});
    gridStructure.push({name:"Hostile", field:"GetIsHostile"});
   
    var featureNames = String("#{featureNames}").split(",");
    for (var i = 0; i < featureNames.length; i++) {
        if (enabledFeatures.charAt(i) == "1") gridStructure.push({name:featureNames[i], field:String(i), formatter: featureFormatter});
    }
    
    suspectGrid = new DataGrid(
    {
      store: dataStore = dojo.data.ObjectStore({objectStore: suspectStore, clearOnClose: true}),
      sortInfo: -2,
      structure: gridStructure,
      rowsPerPage: 20
    }, 
    "nova_suspects"
    );
    suspectGrid.startup();
    now.sendAllSuspects(now.OnNewSuspect);
    });
    });

    }); });

