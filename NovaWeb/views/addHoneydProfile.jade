extends layout


block headerAdditions
  //link(rel="stylesheet", type="text/css", href="configstyle.css", media="screen")
  script
    var profile;
    var portList = new function() {};
    var newProfile = "#{newProfile}";
    
    var currentName;
    if (newProfile == "true") {
        currentName = "#{parentName}";
        console.log("Creating child of profile " + currentName);
    } else {
        currentName = "#{oldName}";
        console.log("Editing profile " + currentName);
    }

    var inheritanceChanged = function() {};
    var uptimeTypeChanged = function() {};
    var portInheritedChange = function(portUID) {};
    var deletePort = function() {};
    var addPort = function(port) {};
    var portBehaviorChanged = function() {};
    var saveChanges = function() {};
    var savedChanges = function() {};
    var sliderMoved = function(which, len, cb) {};
    var clearCell = function(which, len) {};
    var addVendor = function(vendName) {};
    var deleteAndClean = function(which) {};
    var clearCreated = function() {};

    var portIndexes = [];
    var loaded = false;


    function selectItemByValue(elmnt, value) {
      for(var i=0; i < elmnt.options.length; i++) {
        if(elmnt.options[i].value == value) {
          elmnt.selectedIndex = i;
        }
      }
    }

    require(["dojo/domReady!", "dojo/ready", "dijit/registry", "dijit/form/FilteringSelect"], function() {
    
    // TODO
    if (newProfile != "true") {
        dojo.byId("saveButton").disabled = true;
    }

    addVendor = function(vendName) {
        if(document.getElementById("ethDiv0") == undefined)
        {        
            var teed = document.getElementById("labelDist");
            var teed2 = document.getElementById("ranges");
            var teed3 = document.getElementById("deleteButtonHere");
        
            var div = document.createElement("div");
            
            div.setAttribute("id", "ethDiv0");
            div.setAttribute("style", "width: content_width");
            
            var rangeDiv = document.createElement("div");
            
            rangeDiv.setAttribute("id", "rangeDiv0");
            rangeDiv.setAttribute("style", "width: content_width");
            
            var distribution = document.createElement("input");
                    
            distribution.setAttribute("id", "dist0");
            distribution.setAttribute("type", "range");
            distribution.setAttribute("min", "1");                    
            distribution.setAttribute("max", "100");
            distribution.setAttribute("step", "1");
            distribution.setAttribute("value", 100);
            distribution.setAttribute("readonly", "true");
            distribution.setAttribute("style", "vertical-align: text");
            distribution.setAttribute("onchange", 'sliderMoved("dist0", 1)');
           
            var add = document.createElement("input");
            
            add.setAttribute("id", "vend0");
            add.innerHTML = vendName;
            add.setAttribute("type", "text");
            add.setAttribute("value", vendName);
            add.setAttribute("style", "width: 10");
            add.setAttribute("readonly", "true");
            add.setAttribute("style", "display: inline-block; float: left; clear: left");
                               
            var br = document.createElement("br");
            
            var distLabel = document.createElement("input");
            
            distLabel.setAttribute("id","distLabel0");
            distLabel.setAttribute("value", "100%");
            distLabel.innerHTML = "100%";
            distLabel.setAttribute("type", "text");
            distLabel.setAttribute("readonly", "true");
            distLabel.setAttribute("style","width: 40px; float: right; clear: right");
            distLabel.setAttribute("onchange", 'clearCell("distLabel0", ' + 1 + ')');

            var deleteDiv = document.createElement("div");
            
            deleteDiv.setAttribute("style", "width: content_width");
            deleteDiv.setAttribute("id", "deleteDiv0");

            var deleteButton = document.createElement("button");
            
            deleteButton.setAttribute("id", "delete0");
            deleteButton.setAttribute("type", "button");
            deleteButton.setAttribute("onclick", "deleteAndClean('ethDiv0')");
            deleteButton.innerHTML = "Delete Vendor";

            div.appendChild(add);
            div.appendChild(distLabel);
            teed.appendChild(div);
            rangeDiv.appendChild(distribution);
            rangeDiv.appendChild(br);
            teed2.appendChild(rangeDiv);
            deleteDiv.appendChild(deleteButton);
            deleteDiv.appendChild(br);
            teed3.appendChild(deleteDiv);
            
            document.getElementById("numCreated").setAttribute("value", 1);
        }
        else
        {
            var keepGoing = true;
        
            for(var i = 0; i < parseInt(dojo.byId("numCreated").getAttribute("value")); i++)
            {
                if(vendName == document.getElementById("vend" + i).value)
                {
                    keepGoing = false;
                }
            }
            if(keepGoing)
            {
               for(var i = 0; i < parseInt(dojo.byId("numCreated").getAttribute("value")); i++)
               {
                   document.getElementById("dist" + i).removeAttribute("readonly");
                   document.getElementById("distLabel" + i).removeAttribute("readonly");
               }
        
               document.getElementById("errorEthernet").value = "";
               document.getElementById("errorEthernet").innerHTML = "";
        
               var numCreated = parseInt(document.getElementById("numCreated").getAttribute("value"));
        
               document.getElementById("numCreated").setAttribute("value", (numCreated + 1));
            
               var number = numCreated;
               var checkAgainst = "ethDiv" + number;
               
               var teed = document.getElementById("labelDist");
               var teed2 = document.getElementById("ranges");
               var teed3 = document.getElementById("deleteButtonHere");

               var div = document.createElement("div");
            
               div.setAttribute("id", "ethDiv" + number);
               div.setAttribute("style", "width: content_width");
            
               var rangeDiv = document.createElement("div");
            
               rangeDiv.setAttribute("id", "rangeDiv" + number);
               rangeDiv.setAttribute("style", "width: content_width");
            
               var distribution = document.createElement("input");
                    
               distribution.setAttribute("id", "dist" + number);
               distribution.setAttribute("type", "range");
               distribution.setAttribute("min", "1");                    
               distribution.setAttribute("max", 100 - number);
               distribution.setAttribute("step", "1");
               distribution.setAttribute("value", 1);
               distribution.setAttribute("style", "vertical-align: text");
               distribution.setAttribute("onchange", 'sliderMoved(\"dist' + number + '\", ' + (number + 1) + ')');
           
               var add = document.createElement("input");
            
               add.setAttribute("id", "vend" + number);
               add.innerHTML = vendName;
               add.setAttribute("type", "text");
               add.setAttribute("value", vendName);
               add.setAttribute("style", "width: 10");
               add.setAttribute("readonly", "true");
               add.setAttribute("style", "display: inline-block; float: left; clear: left");
                               
               var br = document.createElement("br");
            
               var distLabel = document.createElement("input");
            
               distLabel.setAttribute("id","distLabel" + number);
               distLabel.setAttribute("value", "1%");
               distLabel.innerHTML = "1%";
               distLabel.setAttribute("type", "text");
               distLabel.setAttribute("style","width: 40px; float: right; clear: right");
               distLabel.setAttribute("onchange", 'clearCell("distLabel' + number + '", ' + (number + 1) + ')');

               var deleteDiv = document.createElement("div");
            
               deleteDiv.setAttribute("style", "width: content_width");
               deleteDiv.setAttribute("id", "deleteDiv" + number);

               var deleteButton = document.createElement("button");
            
               deleteButton.setAttribute("id", "delete" + number);
               deleteButton.setAttribute("type", "button");
               deleteButton.setAttribute("onclick", 'deleteAndClean("ethDiv' + number + '")');
               deleteButton.innerHTML = "Delete Vendor";

               div.appendChild(add);
               div.appendChild(distLabel);
               teed.appendChild(div);
               rangeDiv.appendChild(distribution);
               rangeDiv.appendChild(br);
               teed2.appendChild(rangeDiv);
               deleteDiv.appendChild(deleteButton);
               deleteDiv.appendChild(br);
               teed3.appendChild(deleteDiv);
            
               var deleteOne = true;
              
               for(var i = 0; i < (number + 1); i++)
               {
                   if("ethDiv" + i !== checkAgainst)
                   {
                       var change = document.getElementById("ethDiv" + i);
                       var changeMax = document.getElementById("rangeDiv" + i);
                
                       for(var j = 0; j < change.childNodes.length; j++)
                       {
                           if(change.childNodes[j].id.substr(0, 9) == "distLabel")
                           {
                               if(((change.childNodes[j].value - 1) != 0) && (deleteOne))
                               {
                                    var replace = ((parseInt(change.childNodes[j].value.substr(0, change.childNodes[j].value.length - 1)) - 1).toString() + "%");
                            
                                    change.childNodes[j].value = replace;
                                    change.childNodes[j].innerHTML = replace;
                                    
                                    document.getElementById("dist" + i).setAttribute("value", document.getElementById("dist" + i).value - 1);
                                    deleteOne = false;
                                   //need to modify or obviate the hidden field for user created vendors
                               }
                           }
                       }
                   }
                   
                   document.getElementById("dist" + i).setAttribute("onchange", 'sliderMoved(\"dist' + i + '\", ' + (number + 1) + ')');
                   document.getElementById("dist" + i).setAttribute("max", (100 - number));
                   document.getElementById("distLabel" + i).setAttribute("onchange", 'clearCell("distLabel' + i + '", ' + (number + 1) + ')')
               }
           }
           else
           {
               document.getElementById("errorEthernet").value = "Can't add the same vendor twice";
               document.getElementById("errorEthernet").innerHTML = "Can't add the same vendor twice";
           }
        }
    }

    deleteAndClean = function(which) {
        if(dojo.byId("numCreated").getAttribute("value") == 1)
        {
            document.getElementById("errorEthernet").value = "Can't delete last vendor, must have at least one";
            document.getElementById("errorEthernet").innerHTML = "Can't delete last vendor, must have at least one";
            return;
        }
    
        var whichToDelete = which.substr(6);
        
        // need to go through and delete the divs with whichToDelete as their last character;
        // then, need to go to each element after the deleted one, decrement their ids, as well
        // as modify their function calls and stuff to reflect the changed number of vendors
        var teed = document.getElementById("labelDist");
        var teed2 = document.getElementById("ranges");
        var teed3 = document.getElementById("deleteButtonHere");
        
        var keepGoing = true;
        
        for(var i = 0; i < teed.childNodes.length && keepGoing; i++)
        {
            if(teed.childNodes[i].id == ("ethDiv" + whichToDelete))
            {
                teed.removeChild(teed.childNodes[i]);
                keepGoing = false;
            }
        }
        
        keepGoing = true;
        
        for(var i = 0; i < teed2.childNodes.length && keepGoing; i++)
        {
            if(teed2.childNodes[i].id == ("rangeDiv" + whichToDelete))
            {
                teed2.removeChild(teed2.childNodes[i]);
                keepGoing = false;
            }
        }
        
        keepGoing = true;
        
        for(var i = 0; i < teed3.childNodes.length && keepGoing; i++)
        {
            if(teed3.childNodes[i].id == ("deleteDiv" + whichToDelete))
            {
                teed3.removeChild(teed3.childNodes[i]);
                keepGoing = false;
            }
        }
        
        
        var numCreated = parseInt(dojo.byId("numCreated").getAttribute("value"));
        var newNumCreated = (parseInt(dojo.byId("numCreated").getAttribute("value")) - 1);
        
        for(var i = 0; i < numCreated; i++)
        {
            if(i >= (parseInt(whichToDelete) + 1))
            {
                document.getElementById("ethDiv" + i).id = ("ethDiv" + (i - 1));
                document.getElementById("vend" + i).id = ("vend" + (i - 1));
                document.getElementById("distLabel" + i).setAttribute("onchange", 'clearCell(\"distLabel' + (i - 1) + '\", ' + newNumCreated + ')');
                document.getElementById("distLabel" + i).id = ("distLabel" + (i - 1));
                document.getElementById("rangeDiv" + i).id = ("rangeDiv" + (i - 1));
                document.getElementById("dist" + i).setAttribute("onchange", 'sliderMoved(\"dist' + (i - 1) + '\", ' + newNumCreated + ')');
                document.getElementById("dist" + i).id = ("dist" + (i - 1));
                document.getElementById("delete" + i).setAttribute("onclick", 'deleteAndClean(\"ethDiv' + (i - 1) + '\")');
                document.getElementById("delete" + i).id = ("delete" + (i - 1));
                document.getElementById("deleteDiv" + i).id = ("deleteDiv" + (i - 1));
            }
            else if(i < parseInt(whichToDelete))
            {
                document.getElementById("distLabel" + i).setAttribute("onchange", 'clearCell(\"distLabel' + i + '\", ' + newNumCreated + ')');
                document.getElementById("dist" + i).setAttribute("onchange", 'sliderMoved(\"dist' + i + '\", ' + newNumCreated + ')');
            }
        }
        
        var max = {index: 0, value: dojo.byId("dist0").value};
        var justInCase = {index: 0, value: dojo.byId("dist0").value};
        
        for(var i = 0; i < newNumCreated; i++)
        {
            if(dojo.byId("dist" + i).value > max)
            {
                justInCase.index = max.index;
                justInCase.value = max.value;
                max.index = i;
                max.value = checkSum[i];
            }
        }
        
        if((max.value + 1) < 100)
        {
            max.value = parseInt(max.value) + 1;
            document.getElementById("dist" + max.index).value = max.value;
            document.getElementById("dist" + max.index).max = parseInt(document.getElementById("dist" + max.index).max) + 1;
            document.getElementById("distLabel" + max.index).value = max.value.toString() + "%";
            document.getElementById("distLabel" + max.index).innerHTML = max.value.toString() + "%";
        }
        else
        {
            justInCase.value = parseInt(justInCase.value) + 1;
            document.getElementById("dist" + justInCase.index).value = justInCase.value;
            document.getElementById("dist" + justInCase.index).max = parseInt(document.getElementById("dist" + justInCase.index).max) + 1;
            document.getElementById("distLabel" + justInCase.index).value = justInCase.value.toString() + "%";
            document.getElementById("distLabel" + justInCase.index).innerHTML = justInCase.value.toString() + "%";
        }
        
        dojo.byId("numCreated").setAttribute("value", newNumCreated);
        
        if(parseInt(dojo.byId("numCreated").getAttribute("value")) == 1)
        {
            document.getElementById("dist0").value = 100;
            document.getElementById("dist0").max = 100;
            document.getElementById("distLabel0").value = "100%";
            document.getElementById("distLabel0").innerHTML = "100%";
            
            document.getElementById("distLabel0").setAttribute("readonly","true");
            document.getElementById("dist0").setAttribute("readonly", "true");
        }
    }

    clearCell = function(which, len) {
        var element = document.getElementById(which);
        var text = element.value;
        var maxAllowed = parseInt(document.getElementById("dist" + which[which.length - 1]).getAttribute("max"));
        var numericValue = (text[text.length - 1] == "%" ? parseInt(text.substr(0, text.length - 1)) : parseInt(text));
        
        if(numericValue == 0)
        {
            document.getElementById("errorEthernet").value = "Cannot have 0% distribution for a vendor";
            document.getElementById("errorEthernet").innerHTML = "Cannot have 0% distribution for a vendor";
            
            var stringToReplace = (document.getElementById("dist" + which[which.length - 1]).value).toString() + "%";
            
            element.value = (document.getElementById("dist" + which[which.length - 1]).value).toString() + "%";
        }
        else if(numericValue < 1 || numericValue > maxAllowed)
        {
            document.getElementById("errorEthernet").value = "Invalid value for distribution, must be an integer between 1 and " + maxAllowed;
            document.getElementById("errorEthernet").innerHTML = "Invalid value for distribution, must be an integer between 1 and " + maxAllowed;
            
            var stringToReplace = (document.getElementById("dist" + which[which.length - 1]).value).toString() + "%";
            
            element.value = (document.getElementById("dist" + which[which.length - 1]).value).toString() + "%";
        }
        else
        {
            document.getElementById("errorEthernet").value = "";
            document.getElementById("errorEthernet").innerHTML = "";
        
            if(text[text.length - 1] != "%")
            {
                element.value += "%";
            
                sliderMoved("dist" + which[which.length - 1], len, text);
            }
            else if(document.getElementById("dist" + which[which.length - 1]).value != document.getElementById(which).value)
            {
                sliderMoved("dist" + which[which.length - 1], len, text);
            }
        }
    }

    sliderMoved = function(which, len, cb) {
    
        if(cb != undefined)
        {
            dojo.byId(which).value = cb;
        }
    
        var changeArray = [];
        
        var checkAgainst = which[which.length - 1];
        
        for(var i = 0; i < len; i++)
        {
            changeArray.push(parseInt(document.getElementById("dist" + i).value));
        }
        
        var total = 0;
        
        for(var i in changeArray)
        {
            total += parseInt(changeArray[i]);
        }
        
        var reduction = 100 - total;
        
        var sumOfOtherElements = parseInt(total - changeArray[checkAgainst]);
        
        var modifiers = [];
        
        for(var i in changeArray)
        {
            if(i != checkAgainst)
            {
                var mult = parseFloat(changeArray[i] / sumOfOtherElements);
                modifiers.push(parseFloat(reduction * mult));
            }
        }
        
        var max = 0;
        
        for(var i = 0; i < modifiers.length - 1; i++)
        {
            var roundingVal = modifiers[i] + 0.5;
            
            if(Math.floor(roundingVal) == Math.floor(modifiers[i]))
            {
                modifiers[i] = Math.floor(roundingVal);
                modifiers[i + 1] += parseFloat(roundingVal % 1);
            }
            else
            {
                modifiers[i] = Math.floor(roundingVal);
                modifiers[i + 1] -= roundingVal % 1;
            }
            
            max += (modifiers[i] / 1);
        }
        
        modifiers[modifiers.length - 1] = (reduction - max);
        
        var j = 0;
        
        for(var i in changeArray)
        {
            if((i != checkAgainst) && (changeArray[i] + modifiers[j] > 0))
            {
                changeArray[i] += modifiers[j];
                j++;
            }
            else if((i != checkAgainst) && !(changeArray[i] + modifiers[j] > 0))
            {
                var ltOrEqZero = parseInt(changeArray[i] + modifiers[j]);
                 
                while(ltOrEqZero <= 0)
                {
                    modifiers[j] += 1;
                    modifiers[j + 1] -= 1;
                    ltOrEqZero = parseInt(changeArray[i] + modifiers[j]);
                }
                
                changeArray[i] += modifiers[j];
               
                j++;
            }
        }
        
        var checkSum = 0;
        
        for(var i in changeArray)
        {
            checkSum += parseInt(changeArray[i]);
        }
        
        for(var i in changeArray)
        {
            var dist = document.getElementById("dist" + i);
            var distLabel = document.getElementById("distLabel" + i);
        
            dist.value = changeArray[i];
            distLabel.value = changeArray[i].toString() + "%";
            distLabel.innerHTML = changeArray[i].toString() + "%";
        }
        
        if(dojo.byId("numCreated").value == 1)
        {
            document.getElementById("dist0").value = 100;
            document.getElementById("dist0").max = 100;
            document.getElementById("distLabel0").value = "100%";
            document.getElementById("distLabel0").innerHTML = "100%";
            document.getElementById("distLabel0").setAttribute("readonly","true");
            document.getElementById("dist0").setAttribute("readonly", "true");
        }
    }
 
    function obj() {};
    saveChanges = function() {
        var pfile = new obj();
        var ports = new obj();
        
        var ethVendorList = [];
        
        var checkLength1 = parseInt(document.getElementById("ethVendorLength").getAttribute("value"));
        var checkLength2 = parseInt(document.getElementById("numCreated").getAttribute("value"));
        
        if(checkLength1 == 0 && checkLength2 > 0)
        {
            var forLength = checkLength2; 
        
            for(var i = 0; i < forLength; i++)
            {
                var element = {vendor: "", dist: ""};
                element.vendor = document.getElementById("vend" + i).value;
                element.dist = parseFloat(document.getElementById("dist" + i).value);
                ethVendorList.push(element);
            }
        }
        else if(checkLength2 == 0 && checkLength1 > 0)
        {
                var forLength = checkLength1;
        
            for(var i = 0; i < forLength; i++)
            {
                var element = {vendor: "", dist: ""};
                element.vendor = document.getElementById("vend" + i).value;
                element.dist = parseFloat(document.getElementById("dist" + i).value);
                ethVendorList.push(element);
            }
        }
        else
        {
            document.getElementById("errorEthernet").value = "Must choose to either inherit ethernet vendors or select at least one";
            document.getElementById("errorEthernet").innerHTML = "Must choose to either inherit ethernet vendors or select at least one";
            return;
        }
        
        pfile.oldName = "#{oldName}";
        pfile.parentProfile = dojo.byId("parentName").value;
        pfile.name = dojo.byId("name").value;
        pfile.tcpAction = dojo.byId("tcpAction").value;
        pfile.udpAction = dojo.byId("udpAction").value;
        pfile.icmpAction = dojo.byId("icmpAction").value;
        pfile.personality = dojo.byId("personality").value;
        pfile.ethernet = dojo.byId("ethernet").value;
        pfile.dropRate = dojo.byId("dropRate").value;
        pfile.uptimeMin = dojo.byId("uptimeMin").value;

        if (dojo.byId("uptimeType").selectedIndex == 0) {
            pfile.uptimeMin = dojo.byId("uptimeMin").value;
        } else {
            pfile.uptimeMin = dojo.byId("uptimeMin").value;
        }


        pfile.isPersonalityInherited = dojo.byId("inheritPersonality").checked;
        pfile.isEthernetInherited = dojo.byId("inheritEthernet").checked;
        pfile.isDropRateInherited = dojo.byId("inheritDropRate").checked;
        pfile.isUptimeInherited = dojo.byId("inheritUptime").checked;
        pfile.isTcpActionInherited = dojo.byId("inheritTcpAction").checked;
        pfile.isUdpActionInherited = dojo.byId("inheritUdpAction").checked;
        pfile.isIcmpActionInherited = dojo.byId("inheritIcmpAction").checked;

        ports.size = portIndexes.length;
        for (var i = 0; i < portIndexes.length; i++) {
            ports[i] = new obj();
            ports[i].portNum = dojo.byId("portNum" + portIndexes[i]).value;
            ports[i].behavior = dojo.byId("portBehavior" + portIndexes[i]).value;
            ports[i].type = dojo.byId("portType" + portIndexes[i]).value;
            ports[i].script = dojo.byId("portScriptDrop" + portIndexes[i]).value;
            ports[i].isInherited = dojo.byId("portInherited" + portIndexes[i]).checked;
        }

        now.SaveProfile(pfile, ports, savedChanges, ethVendorList, true);
    }

    savedChanges = function() {
        window.location="configHoneydProfiles";
    }

    addPort = function(port) {
        if (port == undefined) {
            port = function() {};
            port.portNum = 0;
            port.type = "TCP";
            port.behavior = "open";
            port.isInherited = false;
            port.scriptName = "NA";
        }

        var portDiv = dojo.byId("portTable");
        var portUID;

        if (portIndexes.length > 0) {
            portUID = portIndexes[portIndexes.length - 1] + 1;
        } else {
            portUID = 0;
        }
        
        portIndexes.push(portUID);

        var row = "<tr id='portRow" + portUID + "'>";

        if (!port.isInherited) {
            row += "<td><input disabled='true' type='checkbox' id='portInherited" + portUID + "'> Inherited? </td>";
            row += "<td><input id='portNum" + portUID + "' type='number' min=1 max=65535 value=" + port.portNum + "> </td>";
            row += "<td><select id ='portType";
        } else {
            row += "<td><input type='checkbox' id='portInherited" + portUID + "' onchange='portInheritedChange(" + portUID + ")' CHECKED> Inherited? </td>";
            row += "<td><input id='portNum" + portUID + "' type='number' disabled='true' min=1 max=65535 value=" + port.portNum + "> </td>";
            row += "<td><select disabled='true' id ='portType";
        }
       
        row += portUID;
        row += "'>";
        options = ["UDP", "TCP"];
        for (j = 0; j < options.length; j++) {
            if (port.type == options[j]) {
                row += "<option value='" + j + "' SELECTED>" + options[j] + "</option>";
            } else {
                row += "<option value='" + j + "'>" + options[j] + "</option>";
            }
        }
        row += "</select></td>";

        row += "<td><select onchange='portBehaviorChanged()' id='portBehavior" + portUID + "'>"; 
        options = ["closed", "reset", "open", "script"];
        for (j = 0; j < options.length; j++) {
            if (port.behavior == options[j]) {
                row += "<option value='" + j + "' SELECTED>" + options[j] + "</option>";
            } else {
                row += "<option value='" + j + "'>" + options[j] + "</option>";
            }
        }
        row += "</select></td>";
        


        row += "<td><select id='portScriptDrop";
        row += portUID;
        row += "'>"; 
        var scripts = "#{scripts}";
        options = scripts.split(",");
        matchingScriptFound = false;
        for (j = 0; j < options.length; j++) {
            if (port.scriptName == options[j]) {
                row += "<option SELECTED>" + options[j] + "</option>";
                matchingScriptFound = true;
            } else {
                row += "<option>" + options[j] + "</option>";
            }
        }

        // Have a blank option if no script is selected
        if (!matchingScriptFound) {
            row += "<option disabled='true' SELECTED>NA</option>";
        } else {
            row += "<option disabled='true'>NA</option>";
        }
        row += "</td></select>"; 


        // Delete button 
        if (port.isInherited) {
          row += "<td><button type='button' disabled = 'true'/> Inherited </td>";
        } else {
          row += "<td><button type='button' onClick='deletePort(" + portUID + ")'/> Delete </td>";
        }
 
        row += "</tr>";

        dojo.byId("portTable").innerHTML += row;

        portBehaviorChanged();
        portInheritedChange(portUID);
    }
    
    // Disable editing if inherited
    portInheritedChange = function(portUID) {
        if (dojo.byId("portInherited" + portUID).checked) {
            dojo.byId("portBehavior" + portUID).disabled = true;
            dojo.byId("portScriptDrop" + portUID).disabled = true;

            var behavior = portList[Number(dojo.byId("portNum" + portUID).value)].behavior;
            
            selectItemByValue(dojo.byId("portScriptDrop" + portUID), "NA");

            if (behavior == "closed") {
                dojo.byId("portBehavior" + portUID).value = 0;
            } else if (behavior == "reset") {
                dojo.byId("portBehavior" + portUID).value = 1;
            } else if (behavior == "open") {
                dojo.byId("portBehavior" + portUID).value = 2;
            } else if (behavior == "script") {
                dojo.byId("portBehavior" + portUID).value = 3;
                selectItemByValue(dojo.byId("portScriptDrop" + portUID), portList[Number(dojo.byId("portNum" + portUID).value)].scriptName);
            }

            
        } else {
            dojo.byId("portBehavior" + portUID).disabled = false;
            portBehaviorChanged(); 
        }
    }

    uptimeTypeChanged = function() {
        if (dojo.byId("uptimeType").selectedIndex == 0) {
            dojo.byId("uptimeMax").style.display = "none";
            document.getElementById("uptimeLabel").innerHTML = "Uptime";
        } else {
            dojo.byId("uptimeMax").style.display = "block"; 
            document.getElementById("uptimeLabel").innerHTML = "Uptime Range";
        }
    }

    portBehaviorChanged = function() {
        for (var i = 0; i < portIndexes.length; i++) {
            if (dojo.byId("portBehavior" + portIndexes[i]).value == "3") {
                if (!dojo.byId("portInherited" + portIndexes[i]).checked) {
                    dojo.byId("portScriptDrop" + portIndexes[i]).disabled = false;
                }
            } else {
                dojo.byId("portScriptDrop" + portIndexes[i]).disabled = true;
            }
        }
    }

    deletePort = function(portUID) {
        var row = dojo.byId("portRow" + portUID);
        row.parentNode.removeChild(row);
        var idx = portIndexes.indexOf(portUID);
        if (idx != -1) {
            portIndexes.splice(idx, 1);
        }
    }
    
    clearCreated = function() {
        var numToDelete = parseInt(document.getElementById("numCreated").getAttribute("value"));
        
        if(numToDelete >= 1)
        {
            var labelDist = document.getElementById("labelDist");
            var ranges = document.getElementById("ranges");
            var deleteButtons = document.getElementById("deleteButtonHere");
        
            for(var i = 0; i < numToDelete; i++)
            {
                labelDist.removeChild(document.getElementById("ethDiv" + i));
                ranges.removeChild(document.getElementById("rangeDiv" + i));
                
                if(deleteButtons.childNodes.length > 1)
                {
                    deleteButtons.removeChild(document.getElementById("deleteDiv" + i));
                }
            }
        }
        
        document.getElementById("numCreated").setAttribute("value", "0");
    }
    
    inheritanceChanged = function() {
        if (dojo.byId("personality").disabled = dojo.byId("inheritPersonality").checked) {
            dojo.byId("personality").value = profile.personality;
            dijit.byId("personality").setDisabled(true);
        } else {
            dijit.byId("personality").setDisabled(false);
        }

        if(dojo.byId("inheritEthernet").checked) 
        {       
            dijit.byId("ethernet").setDisabled(true);
            dojo.byId("ethSelectButton").disabled = true;
            
            now.GetInheritedEthernetList(document.getElementById("parentName").value, 
            function(elements, distributions){
                var oldEthVendLength = parseInt(document.getElementById("ethVendorLength").value);
                
                if((oldEthVendLength == 0) || (oldEthVendLength != elements.length))
                {
                    document.getElementById("ethVendorLength").value = elements.length;

                    document.getElementById("errorEthernet").value = "";
                    document.getElementById("errorEthernet").innerHTML = "";

                    var teed = document.getElementById("labelDist");
                    var teed2 = document.getElementById("ranges");
                    var teed3 = document.getElementById("deleteButtonHere");

                    var teedFor = teed.childNodes.length;
                    var teed2For = teed2.childNodes.length;
                    var teed3For = teed3.childNodes.length;

                    clearCreated();

                    for(var i in elements)
                    {
                        var distro = distributions[i];
                
                        if(Math.floor(distro + 0.5) == Math.floor(distro))
                        {
                            distributions[i] = Math.ceil(distro);
                            distributions[i + 1] += distro % 1; 
                        }
                        else
                        {
                            distributions[i] = Math.floor(distro);
                            distributions[i + 1] -= distro % 1; 
                        }
                
                        var div = document.createElement("div");
                
                        div.setAttribute("id", "ethDiv" + i);
                        div.setAttribute("style", "width: content_width");
                    
                        var rangeDiv = document.createElement("div");
                
                        rangeDiv.setAttribute("id", "rangeDiv" + i);
                        rangeDiv.setAttribute("style", "width: content_width");
                   
                        var add = document.createElement("input");
                    
                        add.setAttribute("id", "vend" + i);
                        add.innerHTML = elements[i];
                        add.setAttribute("type", "text");
                        add.setAttribute("value", elements[i]);
                        add.setAttribute("style", "width: 10");
                        add.setAttribute("readonly", "true");
                        add.setAttribute("style", "display: inline-block; float: left; clear: left");
                                           
                        var br = document.createElement("br");
                    
                        var distLabel = document.createElement("input");
                    
                        distLabel.setAttribute("id","distLabel" + i);
                        distLabel.setAttribute("value", distributions[i] + "%");
                        distLabel.innerHTML = distributions[i] + "%";
                        distLabel.setAttribute("type", "text");
                        distLabel.setAttribute("style","width: 40px; float: right; clear: right");
                        distLabel.setAttribute("readonly", true);
                        distLabel.setAttribute("onchange", 'clearCell("distLabel' + i + '", ' + elements.length + ')');
    
                        var distribution = document.createElement("input");
                    
                        distribution.setAttribute("id", "dist" + i);
                        distribution.setAttribute("type", "range");
                        distribution.setAttribute("min", "1");                    
                        distribution.setAttribute("max", 100 - elements.length);
                        distribution.setAttribute("step", "1");
                        distribution.setAttribute("value", distributions[i]);
                        distribution.setAttribute("style", "vertical-align: text");
                        distribution.setAttribute("readonly", true);
                        distribution.setAttribute("onchange", 'sliderMoved("dist' + i + '", ' + elements.length + ')');

                        div.appendChild(add);
                        div.appendChild(distLabel);
                        teed.appendChild(div);
                        rangeDiv.appendChild(distribution);
                        rangeDiv.appendChild(br);
                        teed2.appendChild(rangeDiv);
                    
                        if(dojo.byId("ethVendorLength").value == 1)
                        {
                            document.getElementById("dist0").value = 100;
                            document.getElementById("dist0").max = 100;
                            document.getElementById("distLabel0").value = "100%";
                            document.getElementById("distLabel0").innerHTML = "100%";
                            document.getElementById("distLabel0").setAttribute("readonly","true");
                            document.getElementById("dist0").setAttribute("readonly", "true");
                        }
                    }    
                }
            });     
        }
        else 
        {
            dojo.byId("ethSelectButton").disabled = false;
            dijit.byId("ethernet").setDisabled(false);
            
            dojo.byId("ethVendorLength").value = "0";
            
            var deletes = document.getElementById("row3").childNodes;
            
            try
            {
                for(var i in deletes)
                {
                    if(deletes[i].tagName == "TD" && deletes[i].getAttribute("id") == "labelDist")
                    {
                        var forLength = deletes[i].childNodes.length;
                        for(var j = 0; j < forLength; j++)
                        {
                            deletes[i].removeChild(deletes[i].childNodes[0]);
                        }
                    }
                    else if(deletes[i].tagName == "TD" && deletes[i].getAttribute("id") == "ranges")
                    {
                        var forLength = deletes[i].childNodes.length;
                        for(var j = 0; j < forLength; j++)
                        {                     
                            deletes[i].removeChild(deletes[i].childNodes[0]);
                        }
                    }
                }
            }
            catch(err)
            {
                // This'll catch much the same as the nested try catch;
                // there's some stuff inside a tag that getAttribute() 
                // can't be called on (Object#<Comment>) but it's 
                // easier to just let the error happen than develop logic
                // to avoid those elements. I'll try experimenting with using
                // tagName stuff a little bit but this'll be how it is for now.
            }
            if(newProfile == "false" && document.getElementById("dist0") === undefined)
            {
                now.GetVendors(document.getElementById("name").value, function(elements, distributions){
                
                document.getElementById("numCreated").value = elements.length;

                document.getElementById("errorEthernet").value = "";
                document.getElementById("errorEthernet").innerHTML = "";

                var teed = document.getElementById("labelDist");
                var teed2 = document.getElementById("ranges");
                var teed3 = document.getElementById("deleteButtonHere");

                var teedFor = teed.childNodes.length;
                var teed2For = teed2.childNodes.length;
                var teed3For = teed3.childNodes.length;

                for(var i in elements)
                {
                    var distro = distributions[i];
                
                    if(Math.floor(distro + 0.5) == Math.floor(distro))
                    {
                        distributions[i] = Math.ceil(distro);
                        distributions[i + 1] += distro % 1; 
                    }
                    else
                    {
                        distributions[i] = Math.floor(distro);
                        distributions[i + 1] -= distro % 1; 
                    }
                
                    var div = document.createElement("div");
                
                    div.setAttribute("id", "ethDiv" + i);
                    div.setAttribute("style", "width: content_width");
                
                    var rangeDiv = document.createElement("div");
                
                    rangeDiv.setAttribute("id", "rangeDiv" + i);
                    rangeDiv.setAttribute("style", "width: content_width");
                   
                    var add = document.createElement("input");
                    
                    add.setAttribute("id", "vend" + i);
                    add.innerHTML = elements[i];
                    add.setAttribute("type", "text");
                    add.setAttribute("value", elements[i]);
                    add.setAttribute("style", "width: 10");
                    add.setAttribute("readonly", "true");
                    add.setAttribute("style", "display: inline-block; float: left; clear: left");
                                       
                    var br = document.createElement("br");
                    
                    var distLabel = document.createElement("input");
                    
                    distLabel.setAttribute("id","distLabel" + i);
                    distLabel.setAttribute("value", distributions[i] + "%");
                    distLabel.innerHTML = distributions[i] + "%";
                    distLabel.setAttribute("type", "text");
                    distLabel.setAttribute("readonly", "true");
                    distLabel.setAttribute("style","width: 40px; float: right; clear: right");
                    distLabel.setAttribute("onchange", 'clearCell("distLabel' + i + '", ' + elements.length + ')');

                    var distribution = document.createElement("input");
                    
                    distribution.setAttribute("id", "dist" + i);
                    distribution.setAttribute("type", "range");
                    distribution.setAttribute("min", "1");
                               
                    if(elements.length > 1)
                    {         
                        distribution.setAttribute("max", 100 - elements.length);
                    }
                    else if(elements.length == 1)
                    {
                        distribution.setAttribute("max", "100");
                    }
                    
                    distribution.setAttribute("step", "1");
                    distribution.setAttribute("value", distributions[i]);
                    distribution.setAttribute("readonly", "true");
                    distribution.setAttribute("style", "vertical-align: text");
                    distribution.setAttribute("onchange", 'sliderMoved("dist' + i + '", ' + elements.length + ')');

                    var deleteDiv = document.createElement("div");
            
                    deleteDiv.setAttribute("style", "width: content_width");
                    deleteDiv.setAttribute("id", "deleteDiv" + i);

                    var deleteButton = document.createElement("button");
            
                    deleteButton.setAttribute("id", "delete" + i);
                    deleteButton.setAttribute("type", "button");
                    deleteButton.setAttribute("onclick", 'deleteAndClean("ethDiv' + i + '")');
                    deleteButton.innerHTML = "Delete Vendor";

                    div.appendChild(add);
                    div.appendChild(distLabel);
                    teed.appendChild(div);
                    rangeDiv.appendChild(distribution);
                    rangeDiv.appendChild(br);
                    teed2.appendChild(rangeDiv);
                    deleteDiv.appendChild(deleteButton);
                    teed3.appendChild(deleteDiv);
                }
                
                if(dojo.byId("numCreated").value == 1)
                {
                    document.getElementById("dist0").value = 100;
                    document.getElementById("dist0").max = 100;
                    document.getElementById("distLabel0").value = "100%";
                    document.getElementById("distLabel0").innerHTML = "100%";
                    document.getElementById("distLabel0").setAttribute("readonly","true");
                    document.getElementById("dist0").setAttribute("readonly", "true");
                }
            });
            }
        }

        if (dojo.byId("dropRate").disabled = dojo.byId("inheritDropRate").checked) {
            dojo.byId("dropRate").value = profile.dropRate;
        }
        
        if (dojo.byId("uptimeMin").disabled = dojo.byId("inheritUptime").checked) {
            dojo.byId("uptimeMin").value = profile.uptimeMin;
        }

        if (dojo.byId("uptimeMax").disabled = dojo.byId("inheritUptime").checked) {
            dojo.byId("uptimeMax").value = profile.uptimeMax;
        }

        if (dojo.byId("uptimeType").disabled = dojo.byId("inheritUptime").checked) {
            if (profile.uptimeMin == profile.uptimeMax) {
               dojo.byId("uptimeType").selectedIndex = 0;
            } else {
               dojo.byId("uptimeType").selectedIndex = 1; 
            }
        }
        
        if (dojo.byId("tcpAction").disabled = dojo.byId("inheritTcpAction").checked) {
            if (profile.tcpAction == "reset") {
                dojo.byId("tcpAction").selectedIndex = 0;
            } else if (profile.tcpAction == "block") {
                dojo.byId("tcpAction").selectedIndex = 1;
            } else if (profile.tcpAction == "open") {
                dojo.byId("tcpAction").selectedIndex = 2;
            }
        }
        
        if (dojo.byId("udpAction").disabled = dojo.byId("inheritUdpAction").checked) {
            if (profile.udpAction == "reset") {
                dojo.byId("udpAction").selectedIndex = 0;
            } else if (profile.udpAction == "block") {
                dojo.byId("udpAction").selectedIndex = 1;
            } else if (profile.udpAction == "open") {
                dojo.byId("udpAction").selectedIndex = 2;
            }
        }
        
        if (dojo.byId("icmpAction").disabled = dojo.byId("inheritIcmpAction").checked) {
            if (profile.icmpAction == "reset") {
                dojo.byId("icmpAction").selectedIndex = 0;
            } else if (profile.icmpAction == "block") {
                dojo.byId("icmpAction").selectedIndex = 1;
            } else if (profile.icmpAction == "open") {
                dojo.byId("icmpAction").selectedIndex = 2;
            }
        }
        
        
        uptimeTypeChanged();
    }
    
    now.ready(function() {
        if (loaded) {
          return;
        } else {
          loaded = true;
        }

        now.GetPorts(currentName, function(ports) {
            for (var i = 0; i < ports.length; i++) {
                portList[ports[i].portNum] = ports[i];
                ports[i].isInherited = true;
                addPort(ports[i]);
            }
           portBehaviorChanged();
        });

          now.GetProfile(currentName, function(pfile){
          profile = pfile;
        
        if (newProfile == "true") {
          dojo.byId("name").value = "New Profile";
          dojo.byId("parentName").value = "#{parentName}";
          dojo.byId("inheritPersonality").checked = true;
          dojo.byId("inheritEthernet").checked = true; 
          dojo.byId("inheritDropRate").checked = true; 
          dojo.byId("inheritUptime").checked = true; 
          dojo.byId("inheritTcpAction").checked = true; 
          dojo.byId("inheritUdpAction").checked = true; 
          dojo.byId("inheritIcmpAction").checked = true;  
        } else {
          dojo.byId("name").value = profile.name;
          dojo.byId("parentName").value = profile.parentProfile;
          dojo.byId("inheritPersonality").checked = profile.isPersonalityInherited;
          dojo.byId("inheritEthernet").checked = profile.isEthernetInherited;
          dojo.byId("inheritDropRate").checked = profile.isDropRateInherited;
          dojo.byId("inheritUptime").checked = profile.isUptimeInherited;
          dojo.byId("inheritTcpAction").checked = profile.isTcpActionInherited;
          dojo.byId("inheritUdpAction").checked = profile.isUdpActionInherited;
          dojo.byId("inheritIcmpAction").checked = profile.isIcmpActionInherited;
        }

          
          if (profile.tcpAction == "reset") {
            dojo.byId("tcpAction").selectedIndex = 0;
          } else if (profile.tcpAction == "block") {
            dojo.byId("tcpAction").selectedIndex = 1;
          } else if (profile.tcpAction == "open") {
            dojo.byId("tcpAction").selectedIndex = 2;
          }

          if (profile.udpAction == "reset") {
            dojo.byId("udpAction").selectedIndex = 0;
          } else if (profile.udpAction == "block") {
            dojo.byId("udpAction").selectedIndex = 1;
          } else if (profile.udpAction == "open") {
            dojo.byId("udpAction").selectedIndex = 2;
          }
         
          if (profile.icmpAction == "reset") {
            dojo.byId("icmpAction").selectedIndex = 0;
          } else if (profile.icmpAction == "block") {
            dojo.byId("icmpAction").selectedIndex = 1;
          } else if (profile.icmpAction == "open") {
            dojo.byId("icmpAction").selectedIndex = 2;
          }

          dojo.byId("personality").value = profile.personality;
          dojo.byId("uptimeMin").value = profile.uptimeMin;
          dojo.byId("uptimeMax").value = profile.uptimeMax;
          dojo.byId("dropRate").value = profile.dropRate;

          inheritanceChanged();
       });
    });
    });


block content
  mixin defaultActionBox(i)
    select(id=i)
      option reset
      option block
      option open

  h2 Adding Profile

  form(method="post", action="/editHoneydProfileSave")

    table(id="tableEditProfile")
      col
      col
      col(style="width:200px")
      col(style="width:300px")
      
      tr(id="row0")
        td
        td
        td(style="text-align:right")
          label Profile Name
        td
          input#name(type="text", name="name")
      
      tr(id="row1")
        td
        td
        td(style="text-align:right")
          label Parent Profile
        td
          input#parentName(type="text", name="name", disabled="true")
      
 
      tr(id="row2")
        td
          input#inheritPersonality(type="checkbox", name="inheritPersonality", onclick="inheritanceChanged()") 
        td
          label Inherit?
        td(style="text-align:right")
          label Operating System Personality
        td
          select#personality(data-dojo-type="dijit.form.FilteringSelect", name="personality", autocomplete="true", pageSize=10)
            each os in personalities
              option(value="#{os}") #{os}
      
      tr(id="row4")
        td
          input#inheritDropRate(type="checkbox", name="inheritDropRate", onclick="inheritanceChanged()") 
        td
          label Inherit?
        td(style="text-align:right")
          label Packet Drop Percentage
        td
          input#dropRate(type="number", name="dropRate", min=0, max=100)


      tr(id="row5")
        td
          input#inheritUptime(type="checkbox", name="inheritUptime", onclick="inheritanceChanged()") 
        td
          label Inherit?
        td(style="text-align:right")
          label Fixed uptime or uptime range?
        td
          select#uptimeType(name="uptimeType", onchange="uptimeTypeChanged()")
            option Fixed
            option Range
        
      tr(id="row6")
        td
        td
        td(style="text-align:right")
          label(id="uptimeLabel") Uptime Range
        td
          input#uptimeMin(type="number", name="uptimeMin", min=0)
          input#uptimeMax(type="number", name="uptimeMax", min=0)

      tr(id="row7")
        td
          input#inheritTcpAction(type="checkbox", name="inheritTcpAction", onclick="inheritanceChanged()") 
        td
          label Inherit?
        td(style="text-align:right")
          label Default TCP Action
        td
          mixin defaultActionBox('tcpAction')
  
      tr(id="row8")
        td
          input#inheritUdpAction(type="checkbox", name="inheritUdpAction", onclick="inheritanceChanged()") 
        td
          label Inherit?
        td(style="text-align:right")
          label Default UDP Action
        td
          mixin defaultActionBox('udpAction')
      tr(id="row9")
        td
          input#inheritIcmpAction(type="checkbox", name="inheritIcmpAction", onclick="inheritanceChanged()") 
        td
          label Inherit?
        td(style="text-align:right")
          label Default ICMP Action
        td
          mixin defaultActionBox('icmpAction')

    br
    
    h3 Profile Ethernet Vendor Configuration
    table(style="_min-height: 100px")
      tr(id="row3")
        td
          input#inheritEthernet(type="checkbox", name="inheritEthernet", onclick="inheritanceChanged()") 
        td
          label Inherit?
        td(id="labelDist", style="text-align:right")
        td(id="ranges")
        td(id="deleteButtonHere")        
     
     div(id="ethSelectDiv")
       button(type="button", id="ethSelectButton", onclick="addVendor(document.getElementById('ethernet').value)") Add New Vendor

       select#ethernet(data-dojo-type="dijit.form.FilteringSelect", name="ethernet", autocomplete="true", pageSize=10)
         each vendor in vendors
           option(value="#{vendor}") #{vendor}
              
      
    label(id="errorEthernet", style="color:red;", value="")
      
    hidden(id="ethVendorLength", value="")
    hidden(id="numCreated", value="0")
    
    h3 Profile Port Configuration
    table#portTable

    button(type="button", onClick="addPort()") Add New Port

    br
    br
    br
    
    button#saveButton(type="button", onclick="saveChanges()") Add Profile

